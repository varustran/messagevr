<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cOS Ultra | Automated Flasher</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        :root {
            --pixel-font: 'Press Start+2P', cursive;
            --monospace-font: 'Courier New', Courier, monospace;
            --primary-color: #FFFFFF;
            --secondary-color: #000000;
            --glow-color: rgba(255, 255, 255, 0.2);
            --success-color: #00FF00;
            --error-color: #FF453A;
            --info-color: #00BFFF;
        }
        body {
            background: linear-gradient(-45deg, #000000, #1a1a1a, #000000, #2b2b2b);
            background-size: 400% 400%;
            animation: gradientBG 25s ease infinite;
            color: var(--primary-color);
            font-family: var(--pixel-font);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            text-align: center;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        .container {
            width: 90%;
            max-width: 900px;
            padding: 40px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.15);
            background-color: rgba(20, 20, 20, 0.5);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }
        h1 { font-size: 2.2rem; text-shadow: 0 0 15px var(--glow-color); margin-bottom: 30px; letter-spacing: -2px; }
        
        .button-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .log-container {
            background-color: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            height: 250px;
            margin-bottom: 20px;
            overflow-y: scroll;
            text-align: left;
            padding: 15px;
        }
        #log {
            font-family: var(--monospace-font);
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log-entry.error { color: var(--error-color); }
        .log-entry.success { color: var(--success-color); }

        .btn {
            font-family: var(--pixel-font);
            background-color: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            padding: 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            border-radius: 10px;
        }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: rgba(255, 255, 255, 0.3); }
        .btn:not(:disabled):hover { background-color: var(--primary-color); color: var(--secondary-color); box-shadow: 0 0 25px var(--primary-color); }
    </style>
</head>
<body>
    <div class="container">
        <h1>cOS Ultra Flasher</h1>
        
        <div class="button-group">
            <button class="btn" id="connect-btn">1. Kết Nối</button>
            <button class="btn" id="flash-btn" disabled>2. Xóa & Cài Đặt cOS</button>
        </div>

        <div class="log-container">
            <pre id="log"></pre>
        </div>

    </div>

    <!-- Import the ESPLoader library -->
    <script type="module">
        import { ESPLoader, Transport } from "https://unpkg.com/esptool-js@0.4.3/bundle.js";

        const connectBtn = document.getElementById("connect-btn");
        const flashBtn = document.getElementById("flash-btn");
        const log = document.getElementById("log");

        const BAUD_RATE = 115200;
        let device = null;
        let transport;
        let esploader;

        function addLog(level, message) {
            const now = new Date();
            const time = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${level}`;
            logEntry.textContent = `[${time}] ${message}`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }

        connectBtn.addEventListener("click", async () => {
            if (device) {
                await transport.disconnect();
                device = null;
                transport = null;
                connectBtn.textContent = "1. Kết Nối";
                flashBtn.disabled = true;
                addLog("info", "Đã ngắt kết nối.");
                return;
            }

            try {
                addLog("info", "Đang chờ chọn cổng COM...");
                device = await navigator.serial.requestPort({});
                transport = new Transport(device);

                addLog("info", "Đang kết nối với cPod...");
                
                // Initialize ESPLoader with a simple logger
                esploader = new ESPLoader(transport, BAUD_RATE, {
                    write: (s) => addLog("info", s),
                    writeln: (s) => addLog("info", s),
                });

                // This is the correct, robust connection sequence
                await esploader.connect();
                await esploader.flashId();
                
                // Get chip info using the CORRECT properties from the esploader object
                addLog("success", `Kết nối thành công!`);
                addLog("info", `Chip: ${esploader.chipFamily} - ${esploader.chipName}`);
                addLog("info", `MAC Address: ${esploader.mac_addr}`);
                
                connectBtn.textContent = "Ngắt Kết Nối";
                flashBtn.disabled = false;
            } catch (e) {
                addLog("error", `Lỗi kết nối: ${e.message}`);
                if (transport) await transport.disconnect();
                device = null;
            }
        });
        
        flashBtn.addEventListener("click", async () => {
            if (!esploader) {
                addLog("error", "Chưa kết nối. Vui lòng nhấn nút 'Kết Nối' trước.");
                return;
            }

            flashBtn.disabled = true;
            connectBtn.disabled = true;
            
            try {
                addLog("info", "Đang tải firmware từ GitHub...");
                const manifest_response = await fetch('./firmware/manifest.json');
                if (!manifest_response.ok) throw new Error(`Không tìm thấy file manifest.json (lỗi ${manifest_response.status})`);
                const manifest = await manifest_response.json();
                const part = manifest.builds[0].parts[0];
                
                const firmware_response = await fetch(`./firmware/${part.path}`);
                if (!firmware_response.ok) throw new Error(`Không tìm thấy file ${part.path} (lỗi ${firmware_response.status})`);
                const firmware_buffer = await firmware_response.arrayBuffer();
                
                addLog("success", `Tải xong firmware '${part.path}' (${firmware_buffer.byteLength} bytes).`);
                
                const fileArray = [{ data: firmware_buffer, address: part.offset }];
                
                addLog("info", "Bắt đầu quá trình nạp (sẽ xóa toàn bộ bộ nhớ)...");
                
                // Using the correct `write_flash` method
                await esploader.write_flash(
                    fileArray,
                    '4MB',
                    'dio',
                    '40MHz',
                    true, // compress
                    true, // erase all
                    (bytes_written, total_bytes) => { // Progress callback
                        const percentage = Math.round((bytes_written / total_bytes) * 100);
                        const lastEntry = log.lastChild;
                        const logMsg = `Đang nạp... ${percentage}%`;
                        if (lastEntry && lastEntry.textContent.includes("Đang nạp")) {
                            lastEntry.textContent = `[${new Date().toLocaleTimeString()}] ${logMsg}`;
                        } else {
                            addLog("info", logMsg);
                        }
                    }
                );
                
                addLog("success", "Nạp thành công! Đang khởi động lại thiết bị...");
                await esploader.hard_reset();

            } catch (e) {
                addLog("error", `Lỗi trong quá trình nạp: ${e.message}`);
            } finally {
                if (transport) await transport.disconnect();
                device = null;
                connectBtn.textContent = "1. Kết Nối";
                connectBtn.disabled = false;
                flashBtn.disabled = true;
            }
        });
    </script>
</body>
</html>
